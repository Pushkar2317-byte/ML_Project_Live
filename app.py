"""
Auto-generated Streamlit wrapper for notebook: Untitled1.ipynb

What this app does:
 - Shows a preview of your notebook code
 - Lets you execute the notebook code in a sandboxed namespace
 - Detects functions defined and allows you to call them with no-argument call
 - Saves the generated app and requirements in /mnt/data

Notes:
 - This is an automated conversion. Complex notebooks (with heavy I/O, interactive widgets, long-running downloads)
   may need manual adjustments before deployment.
 - If your functions require arguments, you'll need to edit app.py to add proper input widgets and pass them.
"""

import streamlit as st
import textwrap
import inspect
import types
import sys

st.set_page_config(page_title="Notebook → Streamlit", layout="wide")

st.title("Notebook to Streamlit — Auto wrapper")

with st.expander("Notebook code preview", expanded=False):
    st.code("!pip install cdsapi\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'variable': ['2m_temperature'],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': [\n            '00:00', '06:00', '12:00', '18:00'\n        ],\n        'format': 'netcdf',\n    },\n    'era5_20230101.nc'\n)\n\n\n# ---- cell separator ----\n\n!pip install cdsapi xarray netCDF4 matplotlib cartopy\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\ntry:\n    c = cdsapi.Client()\n    print(\"CDS API is working!\")\nexcept Exception as e:\n    print(\"CDS API ERROR:\", e)\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'variable': ['2m_temperature'],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': ['00:00','06:00','12:00','18:00'],\n        'format': 'netcdf',\n    },\n    'era5_20230101.nc'\n)\n\nprint(\"Download complete: era5_20230101.nc\")\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_20230101.nc\")\nds\n\n\n# ---- cell separator ----\n\nimport matplotlib.pyplot as plt\n\n\nlat = 28.6\nlon = 77.2\n\npoint = ds.sel(latitude=lat, longitude=lon, method=\"nearest\")\n\nplt.figure(figsize=(10,4))\nplt.plot(point.time, point.t2m - 273.15)  # Convert K \u2192 \u00b0C\nplt.title(\"ERA5 2m Temperature (\u00b0C)\")\nplt.xlabel(\"Time\")\nplt.ylabel(\"Temperature (\u00b0C)\")\nplt.grid(True)\nplt.show()\n\n\n# ---- cell separator ----\n\nprint(ds)\n\n# ---- cell separator ----\n\nimport matplotlib.pyplot as plt\n\n# Choose a location (example: New Delhi)\nlat = 28.6\nlon = 77.2\n\n# Select nearest grid point\npoint = ds.sel(latitude=lat, longitude=lon, method=\"nearest\")\n\nplt.figure(figsize=(10,4))\n\n# Use 'valid_time' instead of 'time'\nplt.plot(point.valid_time, point['t2m'] - 273.15)  # Kelvin \u2192 \u00b0C\n\nplt.title(\"ERA5 2m Temperature (\u00b0C) at New Delhi\")\nplt.xlabel(\"Time\")\nplt.ylabel(\"Temperature (\u00b0C)\")\nplt.grid(True)\nplt.show()\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'variable': [\n            '2m_temperature',\n            '2m_dewpoint_temperature',\n            '10m_u_component_of_wind',\n            '10m_v_component_of_wind',\n            'surface_pressure',\n            'total_precipitation'\n        ],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': ['00:00','06:00','12:00','18:00'],\n        'format': 'netcdf',\n    },\n    'era5_multivars_20230101.nc'\n)\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101.nc\")\nprint(ds)\n\n\n# ---- cell separator ----\n\nimport os\nos.listdir()\n\n\n# ---- cell separator ----\n\nimport os\nprint(os.path.getsize(\"era5_multivars_20230101.nc\"))\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101.nc\", engine=\"cfgrib\")\nds\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101.nc\", engine=\"cfgrib\")\nds\n\n\n# ---- cell separator ----\n\nimport sys\nprint(sys.executable)\n\n\n# ---- cell separator ----\n\nimport cfgrib\nimport xarray as xr\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\n    \"era5_multivars_20230101.nc\",\n    engine=\"cfgrib\"\n)\n\nds\n\n\n# ---- cell separator ----\n\nprint(ds.variables)\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'format': 'netcdf',   # IMPORTANT!!!\n        'variable': [\n            '2m_temperature',\n            '10m_u_component_of_wind',\n            '10m_v_component_of_wind',\n            'mean_sea_level_pressure',\n            'total_precipitation'\n        ],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': [\n            '00:00', '06:00', '12:00', '18:00', \n        ],\n    },\n    'era5_multivars_20230101_new.nc'\n)\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101_new.nc\")\nds\n\n\n# ---- cell separator ----\n\nimport os\nos.path.getsize(\"era5_multivars_20230101_new.nc\")\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101_new.nc\")\nds\n\n\n# ---- cell separator ----\n\nwith open(\"era5_multivars_20230101_new.nc\", \"rb\") as f:\n    print(f.read(4))\n\n\n# ---- cell separator ----\n\nimport zipfile\n\nwith zipfile.ZipFile(\"era5_multivars_20230101_new.nc\", \"r\") as z:\n    print(z.namelist())\n\n\n# ---- cell separator ----\n\nimport zipfile\n\nwith zipfile.ZipFile(\"era5_multivars_20230101_new.nc\", \"r\") as z:\n    z.extractall(\"era5_extracted\")\n\n\n# ---- cell separator ----\n\nimport os\nos.listdir(\"era5_extracted\")\n\n\n# ---- cell separator ----\n\nimport xarray as xr\nds = xr.open_dataset(\"era5_extracted/download.nc\")\nds\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds1 = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-accum.nc\")\nds2 = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-instant.nc\")\n\nds = xr.merge([ds1, ds2])\nds\n\n\n# ---- cell separator ----\n\nlist(ds.data_vars)\n\n\n# ---- cell separator ----\n\nimport xarray as xr\nimport numpy as np\nimport matplotlib.pyplot as plt\n\n\n# ---- cell separator ----\n\ninst = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-instant.nc\")\nacc  = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-accum.nc\")\n\n\n# ---- cell separator ----\n\nds = xr.merge([inst, acc])\nds\n\n\n# ---- cell separator ----\n\nds = ds.rename({\n    't2m': 'temperature',\n    'u10': 'u_wind',\n    'v10': 'v_wind',\n    'msl': 'mslp',\n    'tp':  'precip'\n})\n\n\n# ---- cell separator ----\n\nds[\"temperature_c\"] = ds[\"temperature\"] - 273.15\n\n\n# ---- cell separator ----\n\nds[\"precip_mm\"] = ds[\"precip\"] * 1000\n\n\n# ---- cell separator ----\n\nds[\"wind_speed\"] = np.sqrt(ds[\"u_wind\"]**2 + ds[\"v_wind\"]**2)\n\n\n# ---- cell separator ----\n\nlat = 28\n\n# ... (truncated) ...", language="python")

# The original notebook code (full). It will be executed in an isolated namespace when you click 'Load & Inspect'.
orig_code = "!pip install cdsapi\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'variable': ['2m_temperature'],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': [\n            '00:00', '06:00', '12:00', '18:00'\n        ],\n        'format': 'netcdf',\n    },\n    'era5_20230101.nc'\n)\n\n\n# ---- cell separator ----\n\n!pip install cdsapi xarray netCDF4 matplotlib cartopy\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\ntry:\n    c = cdsapi.Client()\n    print(\"CDS API is working!\")\nexcept Exception as e:\n    print(\"CDS API ERROR:\", e)\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'variable': ['2m_temperature'],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': ['00:00','06:00','12:00','18:00'],\n        'format': 'netcdf',\n    },\n    'era5_20230101.nc'\n)\n\nprint(\"Download complete: era5_20230101.nc\")\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_20230101.nc\")\nds\n\n\n# ---- cell separator ----\n\nimport matplotlib.pyplot as plt\n\n\nlat = 28.6\nlon = 77.2\n\npoint = ds.sel(latitude=lat, longitude=lon, method=\"nearest\")\n\nplt.figure(figsize=(10,4))\nplt.plot(point.time, point.t2m - 273.15)  # Convert K \u2192 \u00b0C\nplt.title(\"ERA5 2m Temperature (\u00b0C)\")\nplt.xlabel(\"Time\")\nplt.ylabel(\"Temperature (\u00b0C)\")\nplt.grid(True)\nplt.show()\n\n\n# ---- cell separator ----\n\nprint(ds)\n\n# ---- cell separator ----\n\nimport matplotlib.pyplot as plt\n\n# Choose a location (example: New Delhi)\nlat = 28.6\nlon = 77.2\n\n# Select nearest grid point\npoint = ds.sel(latitude=lat, longitude=lon, method=\"nearest\")\n\nplt.figure(figsize=(10,4))\n\n# Use 'valid_time' instead of 'time'\nplt.plot(point.valid_time, point['t2m'] - 273.15)  # Kelvin \u2192 \u00b0C\n\nplt.title(\"ERA5 2m Temperature (\u00b0C) at New Delhi\")\nplt.xlabel(\"Time\")\nplt.ylabel(\"Temperature (\u00b0C)\")\nplt.grid(True)\nplt.show()\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'variable': [\n            '2m_temperature',\n            '2m_dewpoint_temperature',\n            '10m_u_component_of_wind',\n            '10m_v_component_of_wind',\n            'surface_pressure',\n            'total_precipitation'\n        ],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': ['00:00','06:00','12:00','18:00'],\n        'format': 'netcdf',\n    },\n    'era5_multivars_20230101.nc'\n)\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101.nc\")\nprint(ds)\n\n\n# ---- cell separator ----\n\nimport os\nos.listdir()\n\n\n# ---- cell separator ----\n\nimport os\nprint(os.path.getsize(\"era5_multivars_20230101.nc\"))\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101.nc\", engine=\"cfgrib\")\nds\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101.nc\", engine=\"cfgrib\")\nds\n\n\n# ---- cell separator ----\n\nimport sys\nprint(sys.executable)\n\n\n# ---- cell separator ----\n\nimport cfgrib\nimport xarray as xr\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\n    \"era5_multivars_20230101.nc\",\n    engine=\"cfgrib\"\n)\n\nds\n\n\n# ---- cell separator ----\n\nprint(ds.variables)\n\n\n# ---- cell separator ----\n\nimport cdsapi\n\nc = cdsapi.Client()\n\nc.retrieve(\n    'reanalysis-era5-single-levels',\n    {\n        'product_type': 'reanalysis',\n        'format': 'netcdf',   # IMPORTANT!!!\n        'variable': [\n            '2m_temperature',\n            '10m_u_component_of_wind',\n            '10m_v_component_of_wind',\n            'mean_sea_level_pressure',\n            'total_precipitation'\n        ],\n        'year': '2023',\n        'month': '01',\n        'day': '01',\n        'time': [\n            '00:00', '06:00', '12:00', '18:00', \n        ],\n    },\n    'era5_multivars_20230101_new.nc'\n)\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101_new.nc\")\nds\n\n\n# ---- cell separator ----\n\nimport os\nos.path.getsize(\"era5_multivars_20230101_new.nc\")\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds = xr.open_dataset(\"era5_multivars_20230101_new.nc\")\nds\n\n\n# ---- cell separator ----\n\nwith open(\"era5_multivars_20230101_new.nc\", \"rb\") as f:\n    print(f.read(4))\n\n\n# ---- cell separator ----\n\nimport zipfile\n\nwith zipfile.ZipFile(\"era5_multivars_20230101_new.nc\", \"r\") as z:\n    print(z.namelist())\n\n\n# ---- cell separator ----\n\nimport zipfile\n\nwith zipfile.ZipFile(\"era5_multivars_20230101_new.nc\", \"r\") as z:\n    z.extractall(\"era5_extracted\")\n\n\n# ---- cell separator ----\n\nimport os\nos.listdir(\"era5_extracted\")\n\n\n# ---- cell separator ----\n\nimport xarray as xr\nds = xr.open_dataset(\"era5_extracted/download.nc\")\nds\n\n\n# ---- cell separator ----\n\nimport xarray as xr\n\nds1 = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-accum.nc\")\nds2 = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-instant.nc\")\n\nds = xr.merge([ds1, ds2])\nds\n\n\n# ---- cell separator ----\n\nlist(ds.data_vars)\n\n\n# ---- cell separator ----\n\nimport xarray as xr\nimport numpy as np\nimport matplotlib.pyplot as plt\n\n\n# ---- cell separator ----\n\ninst = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-instant.nc\")\nacc  = xr.open_dataset(\"era5_extracted/data_stream-oper_stepType-accum.nc\")\n\n\n# ---- cell separator ----\n\nds = xr.merge([inst, acc])\nds\n\n\n# ---- cell separator ----\n\nds = ds.rename({\n    't2m': 'temperature',\n    'u10': 'u_wind',\n    'v10': 'v_wind',\n    'msl': 'mslp',\n    'tp':  'precip'\n})\n\n\n# ---- cell separator ----\n\nds[\"temperature_c\"] = ds[\"temperature\"] - 273.15\n\n\n# ---- cell separator ----\n\nds[\"precip_mm\"] = ds[\"precip\"] * 1000\n\n\n# ---- cell separator ----\n\nds[\"wind_speed\"] = np.sqrt(ds[\"u_wind\"]**2 + ds[\"v_wind\"]**2)\n\n\n# ---- cell separator ----\n\nlat = 28.6\nlon = 77.2\n\npoint = ds.sel(latitude=lat, longitude=lon, method=\"nearest\")\npoint\n\n\n# ---- cell separator ----\n\nplt.figure(figsize=(10,4))\nplt.plot(point.valid_time\n, point.temperature_c)\nplt.grid(True)\nplt.title(\"ERA5 Temperature (\u00b0C) \u2013 New Delhi\")\nplt.ylabel(\"\u00b0C\")\nplt.show()\n\n\n# ---- cell separator ----\n\nplt.figure(figsize=(10,5))\nds.wind_speed.isel(time=0).plot()\nplt.title(\"ERA5 Wind Speed (m/s) \u2014 00 UTC\")\nplt.show()\n\n\n# ---- cell separator ----\n\nimport numpy as np\n\nds[\"wind_speed\"] = np.sqrt(ds.u_wind**2 + ds.v_wind**2)\n\n\n# ---- cell separator ----\n\nplt.figure(figsize=(10,5))\nds.wind_speed.isel(valid_time=0).plot()\nplt.title(\"ERA5 Wind Speed (m/s) \u2014 00 UTC\")\nplt.show()\n\n\n# ---- cell separator ----\n\nplt.figure(figsize=(10,5))\n(ds.temperature - 273.15).isel(valid_time=0).plot()\nplt.title(\"ERA5 Temperature (\u00b0C) \u2014 00 UTC\")\nplt.show()\n\n\n# ---- cell separator ----\n\nplt.figure(figsize=(10,5))\nds.mslp.isel(valid_time=0).plot()\nplt.title(\"ERA5 Mean Sea Level Pressure \u2014 00 UTC\")\nplt.show()\n\n\n# ---- cell separator ----\n\nplt.figure(figsize=(10,5))\nds.precip.isel(valid_time=0).plot()\nplt.title(\"ERA5 Total Precipitation \u2014 00 UTC\")\nplt.show()\n\n\n# ---- cell separator ----\n\nimport pandas as pd\nimport numpy as np\n\n# ---- 10 City Coordinates ----\ncities = {\n    \"New_Delhi\":   (28.61, 77.21),\n    \"Mumbai\":      (19.07, 72.88),\n    \"Kolkata\":     (22.57, 88.36),\n    \"Chennai\":     (13.08, 80.27),\n    \"Bengaluru\":   (12.97, 77.59),\n    \"Hyderabad\":   (17.39, 78.49),\n    \"Ahmedabad\":   (23.02, 72.57),\n    \"Pune\":        (18.52, 73.85),\n    \"Jaipur\":      (26.91, 75.79),\n    \"Lucknow\":     (26.85, 80.95)\n}\n\n# Store all city time-series here\ncity_ts = {}\n\nfor city, (lat, lon) in cities.items():\n    # Find nearest ERA5 grid point\n    point = ds.sel(latitude=lat, longitude=lon, method=\"nearest\")\n\n    # Convert to DataFrame\n    df = point.to_dataframe().reset_index()\n\n    # Add city name\n    df[\"city\"] = city\n\n    city_ts[city] = df\n\n    print(f\"Extracted: {city}\")\n\n\n# ---- cell separator ----\n\nfull_df = pd.concat(city_ts.values(), ignore_index=True)\nprint(full_df.head())\n\n\n# ---- cell separator ----\n\nimport numpy as np\n\n# Wind speed\nfull_df[\"wind_speed\"] = np.sqrt(full_df[\"u_wind\"]**2 + full_df[\"v_wind\"]**2)\n\n# Wind direction (degrees from north)\nfull_df[\"wind_dir\"] = (np.degrees(np.arctan2(full_df[\"u_wind\"], full_df[\"v_wind\"])) + 360) % 360\n\n\n# ---- cell separator ----\n\nfull_df[\"temp_c\"] = full_df[\"temperature\"] - 273.15\n\n\n# ---- cell separator ----\n\nfull_df[\"hour\"] = full_df[\"time\"].dt.hour\nfull_df[\"day\"] = full_df[\"time\"].dt.day\nfull_df[\"month\"] = full_df[\"time\"].dt.month\nfull_df[\"dayofyear\"] = full_df[\"time\"].dt.dayofyear\n\n# Cyclic encoding (VERY important for Neural Networks)\nfull_df[\"hour_sin\"] = np.sin(2 * np.pi * full_df[\"hour\"] / 24)\nfull_df[\"hour_cos\"] = np.cos(2 * np.pi * full_df[\"hour\"] / 24)\n\nfull_df[\"month_sin\"] = np.sin(2 * np.pi * full_df[\"month\"] / 12)\nfull_df[\"month_cos\"] = np.cos(2 * np.pi * full_df[\"month\"] / 12)\n\n\n# ---- cell separator ----\n\nfull_df.columns\n\n\n\n# ---- cell separator ----\n\nfull_df = full_df.rename(columns={\"valid_time\": \"time\"})\n\n\n# ---- cell separator ----\n\nfull_df[\"time\"] = pd.to_datetime(full_df[\"time\"])\n\n\n# ---- cell separator ----\n\nfull_df[\"hour\"] = full_df[\"time\"].dt.hour\nfull_df[\"day\"] = full_df[\"time\"].dt.day\nfull_df[\"month\"] = full_df[\"time\"].dt.month\nfull_df[\"dayofyear\"] = full_df[\"time\"].dt.dayofyear\n\n# Cyclic encoding\nfull_df[\"hour_sin\"] = np.sin(2 * np.pi * full_df[\"hour\"] / 24)\nfull_df[\"hour_cos\"] = np.cos(2 * np.pi * full_df[\"hour\"] / 24)\n\nfull_df[\"month_sin\"] = np.sin(2 * np.pi * full_df[\"month\"] / 12)\nfull_df[\"month_cos\"] = np.cos(2 * np.pi * full_df[\"month\"] / 12)\n\n\n# ---- cell separator ----\n\n# Select the important variables for ML\nfeatures = [\n    \"temperature_c\",\n    \"wind_speed\",\n    \"precip_mm\",\n    \"mslp\",\n    \"u_wind\",\n    \"v_wind\",\n    \"hour\", \"day\", \"month\", \"dayofyear\",\n    \"hour_sin\", \"hour_cos\",\n    \"month_sin\", \"month_cos\"\n]\n\n# Include city as categorical feature\nfull_df[\"city\"] = full_df[\"city\"].astype(\"category\")\nfull_df[\"city_code\"] = full_df[\"city\"].cat.codes\n\n# Final feature list including city\nfeatures = features + [\"city_code\"]\n\n# Create the ML dataset\nml_df = full_df[[\"time\", \"city\"] + features]\n\nml_df.head()\n\n\n# ---- cell separator ----\n\nml_df.to_csv(\"era5_ml_dataset_10_cities.csv\", index=False)\n\n\n# ---- cell separator ----\n\n# Sort by time to maintain chronological order\nfull_df = full_df.sort_values(\"time\")\n\n# Train = first 80%, Test = last 20%\ntrain_size = int(len(full_df) * 0.8)\n\ntrain_df = full_df.iloc[:train_size]\ntest_df  = full_df.iloc[train_size:]\n\nprint(len(train_df), \"training rows\")\nprint(len(test_df),  \"testing rows\")\n\n\n# ---- cell separator ----\n\nfrom sklearn.ensemble import RandomForestRegressor\nfrom sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score\n\n# Features to use (keep it simple for small dataset)\nfeature_cols = [\n    \"wind_speed\", \"precip_mm\", \"mslp\",\n    \"hour_sin\", \"hour_cos\",\n    \"month_sin\", \"month_cos\",\n    \"city_code\"\n]\n\nX_train = train_df[feature_cols]\ny_train = train_df[\"temp_c\"]\n\nX_test = test_df[feature_cols]\ny_test = test_df[\"temp_c\"]\n\n# Initialize Random Forest\nrf_model = RandomForestRegressor(\n    n_estimators=50,  # small number for tiny dataset\n    random_state=42\n)\n\n# Train\nrf_model.fit(X_train, y_train)\n\n# Predict\ny_pred = rf_model.predict(X_test)\n\n# Evaluate\nrmse = mean_squared_error(y_test, y_pred, squared=False)\nmae = mean_absolute_error(y_test, y_pred)\nr2 = r2_score(y_test, y_pred)\n\nprint(f\"RMSE: {rmse:.2f} \u00b0C\")\nprint(f\"MAE: {mae:.2f} \u00b0C\")\nprint(f\"R\u00b2 Score: {r2:.2f}\")\n\n\n# ---- cell separator ----\n\nimport matplotlib.pyplot as plt\n\nplt.figure(figsize=(8,5))\nplt.plot(y_test.values, label=\"Actual\", marker='o')\nplt.plot(y_pred, label=\"Predicted\", marker='x')\nplt.title(\"Temperature Prediction \u2014 Test Set\")\nplt.xlabel(\"Sample Index\")\nplt.ylabel(\"Temperature (\u00b0C)\")\nplt.legend()\nplt.grid(True)\nplt.show()\n\n\n# ---- cell separator ----\n\nimport pandas as pd\n\nfeat_importances = pd.Series(rf_model.feature_importances_, index=feature_cols)\nfeat_importances.sort_values(ascending=False).plot(kind='bar', figsize=(8,4))\nplt.title(\"Feature Importance \u2014 Random Forest\")\nplt.show()\n\n\n# ---- cell separator ----\n\nimport joblib\n\njoblib.dump(rf_model, \"rf_demo_model.pkl\")\n\n\n# ---- cell separator ----\n\nloaded_model = joblib.load(\"rf_demo_model.pkl\")\n\n\n# ---- cell separator ----"

st.markdown("---")
st.markdown("## Controls")

col1, col2 = st.columns([1,2])

with col1:
    load = st.button("Load & Inspect Notebook Code")
    exec_once = st.checkbox("Execute cells immediately on Load (may run long jobs)", value=False)

with col2:
    st.write("After loading, functions defined in the notebook will appear in the selector below so you can call them.")

ns = {}
loaded = False

if load:
    try:
        # Execute the notebook code in a fresh namespace dictionary.
        exec_globals = {}
        # Provide streamlit and other common modules inside the namespace so notebook code that expects them won't fail immediately.
        exec_globals['st'] = st
        exec_globals['__name__'] = '__notebook__'
        # Execute
        exec(orig_code, exec_globals)
        ns = exec_globals
        loaded = True
        st.success("Notebook executed in isolated namespace.")
    except Exception as e:
        st.error(f"Error executing notebook code: {e}")
        # still try to load partial namespace
        ns = exec_globals

# If already loaded in a previous run (Streamlit rerun keeps state only if using st.session_state)
if 'ns' in st.session_state:
    ns = st.session_state['ns']
    loaded = True
else:
    if loaded:
        st.session_state['ns'] = ns

if loaded and isinstance(ns, dict):
    # List callable functions defined in namespace
    funcs = [name for name,obj in ns.items() if callable(obj) and getattr(obj, '__module__', None) == '__notebook__' or isinstance(obj, types.FunctionType)]
    vars_list = [name for name,obj in ns.items() if not callable(obj) and not name.startswith('__')]
    st.markdown("### Discovered items")
    st.write("Functions:", funcs)
    st.write("Variables:", vars_list)

    if funcs:
        sel = st.selectbox("Select a function to call (no-arg functions only)", funcs)
        if st.button("Call selected function"):
            try:
                result = ns[sel]()
                st.success("Function executed.")
                st.write("Return value:")
                st.write(result)
            except TypeError as te:
                st.error(f"TypeError calling {sel} — likely it requires arguments: {te}.\n\nPlease edit app.py to add input widgets for arguments.")
            except Exception as e:
                st.error(f"Error calling function {sel}: {e}")

    st.markdown("### Raw namespace (first 50 keys)")
    st.write(list(ns.keys())[:50])

else:
    st.info("Click 'Load & Inspect Notebook Code' to execute and inspect the notebook namespace.")

st.markdown('---')
st.markdown("### Next steps / Manual tweaks")
st.markdown("""
- If your notebook defines a `main()` or `run()` function, this wrapper will let you call it.
- If functions require arguments, edit `app.py` and add `st.text_input`, `st.file_uploader`, etc., then pass those values into the function.
- Replace any blocking/long-running calls with background tasks or buttons.
""")

st.markdown("Generated app files are saved alongside this notebook on the server (in `/mnt/data`).")
